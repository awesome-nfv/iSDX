# Running iSDX with OF-DPA switches

In order for iSDX to be truly useful, it must run at line speed on hardware switches.  We
have taken the following steps to demonstrate this.

1. Configure three hardware switches in the iSDX multi-switch (MS) configuration as shown
below. The switches we chose are Quanta LY2.  To support iSDX's requirement of OpenFlow
1.3, we installed OF-DPA 2.0 running on Open Network Linux.  The switches are connected to
two Linux machines (Dell R630's) via 10GB links as shown.  

 **Current Wiring Configuration**
![Current Wiring Configuration]
(https://docs.google.com/drawings/d/1Z31EwSiUv8rKb9EqCd8TIS5-N9iTvfsiXOKnah7KToA/pub?w=960&h=720)  
 
2. Verify that the types of flow rules generated by iSDX can be supported by OF-DPA on the
Quanta switches.  iSDX rules require:  
Matching on various combinations of:
 * input port
 * eth_type
 * eth_src
 * eth_dst with arbitrary bit masking
 * TCP dst port
 * TCP src port  

 Actions to:
 * forward to a port
 * set eth_src
 * set eth_dst  

 iSDX originally also used two features that we found are not supported by OF-DPA:
 matching on the ARP_TPA and multicast in concert with setting the eth_dst (for ARP).  To
 work around this limitation, we moved these features to a software switch (OVS) as shown
 in the figure.  

 **OF-DPA Matching**  
 OF-DPA defines a pipeline of flow tables, each of which supports different types of
 rules.  Only one of these tables, the Policy ACL table, is relevant to iSDX.  The Policy
 ACL table (table 60) supports matching on the fields listed above, however, it also
 requires that
 all matched packets be VLAN tagged.  The documentation leads one to believe that the VLAN
 table (earlier in the pipeline) must be programmed to add a VLAN tag to untagged traffic;
 however, in practice it appears that a VLAN tag of '1' is added to untagged traffic by
 default and no rules are needed in the VLAN table.

 **OF-DPA Actions**  
 We found that the OF rules generated by iSDX are not directly supported by OF-DPA.  In
 particular, OF-DPA rules cannot directly include actions required by iSDX.
 It is, however, possible to generate equivalent OF rules that OF-DPA *does* support.
 Actions can be placed into an OF group which can then be referenced by rules in the
 Policy ACL table.  For iSDX, there are two relevant types of groups.  An instance of the
 L2 Interface Group holds an output port number, so when a Policy ACL rule needs to
 forward a packet to an output port, the rule references the appropriate L2 Interface
 Group instance.  The L2 Rewrite Group is used to overwrite the MAC src or dst address.
 If a Policy ACL rule needs to overwrite the MAC src or dst address, it references the
 appropriate L2 Rewrite Group instance which in turn references a L2 Interface Group in
 order to forward the modified packet to an output port.
