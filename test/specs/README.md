# Creating Configurations and Tests

This directory includes the specifications for generating representative test configurations.
The gen_test.py script will create all the configuration files needed by iSDX from the corresponding specification file.
In the following diagrams, the black dashed lines indicate an Autonomous System (AS).
The colored dash-dot-dash lines indicate a peering relationship among AS'es (except for test 6 which uses colors to distinguish across multiple outbound rules).

To generate a set of configuration files, run gen_test.py from the test directory.
All configuration files will be places under output/testname where testname is the name of the specification file with the .spec suffix removed.  For example:
```
cd $BASE/test
for i in specs/*.spec
do
    python gen_test.py $i
done
```
will create all the configurations for all the tests.
__Copy each directory to the examples directory.__
__(Currently, tests must be run from the examples directory.)__
Then use startup.sh to run the complete test as shown in the README in the test directory.

## Specification File Format
By convention, participants or autonomous systems (AS) are numbered from **1**.
In a flow rule, the corresponding AS is lettered starting from **a**.
Edge routers, which map to quagga hosts, are identified as the AS letter concatenated with the edge router ID, starting from 1 (although internally and for autogenerated MAC address (see below) the index runs from 0).
If more than 26 AS'es are needed, doubling of letters is used, i.e., participant 27 is **aa**.

A specification file contains the following constructs in the order shown.
- __mode__ 
defines the switch configuration to be used.
Values are either 'multi-switch' or 'multi-table'
- __participants__
declares the number of participants (autonomous systems) to be defined.
- __peers__
declares the peering relationships between participants.
Multiple peerings can be defined.
They must not overlap.
- __participant__
defines the configuration for each AS.
The additional arguments are:
  * participant number - starts with 1
  * autonomous system number
  * switch port number - starts at 3 for mode multi-table and at 5 for mode multi-switch.  The special argument 'PORT' will automatically use the next available port number regardless of mode.
  * mac address for this edge router.
  The special argument 'MAC' will generate a unique MAC address with a known pattern to simplify debugging.
  Currently the format is 08:00:bb:bb:PP:RR where PP is the participant number and RR is the router index.
  * IP address for this interface
  * Additional triplets of port, mac and IP for the other edge routers in this AS
- __announce__ declares the networks that this AS can reach.
The additional arguments are:
  * participant number for these announcements
  * one or more CIDR format network descriptions of the form a.b.c.d/prefix-bits. An interface on the corresponding quagga host will be created with the default address a.b.c.1. if more interfaces are needed, a ':N' after the routing prefix bits will create additional interfaces.  E.g., 100.0.0.0/24:2 will create interfaces for 100.0.0.1 and 100.0.0.2.
- __flow__ defines an inbound or outbound flow rule.
  * outbound rule: `flow source-AS-edge-router tcp_port >> destination_AS`
  * inbound rule: `flow AS-edge-router << tcp_port`
- __node__ defines the listeners that will be created on each quagga host to receive data routed through the switching fabric.
See the description in the test directory README.
The additional arguments are:
  * edge-router (quagga host) for this listener
  * interface name to identify the corresponding network.
  * the IP address for this interface.
  This must correspond to an announced network.
  * one or more tcp ports to listen on
- __test__ defines a data transfer test.
It is used by the traffic manager application to orchestrate the transfers on demand.
The additional arguments are:
  * source edge-router
  * source interface to bind to
  * destination tcp port
  * expected destination edge-router
  * expected destination interface
  * expected destination tcp port
  
  The traffic manager will coordinate with the traffic node on the source edge router to bind a socket to the given interface and send data to the address implied by the destination interface.
  Since in general, there will be multiple edge routers that advertise the same network, it is up to the switching fabric to determine the ultimate destination based on flow rules and possibly default routing (if no flow rules match).
  The use of the destination edge router name in the test is only a convenience to specify that address.
  However, the destination edge router name will be used by the traffic manager to confirm that the data transfer did indeed terminate on the expected edge router, and therefore that the switching fabric properly routed the traffic.
  If it is not found there, the traffic manager will search all edge routers for the transfer results.

The following example is from the specification for test1-ms.
```
mode multi-switch
participants 3
peers 1 2 3

participant 1 100 PORT MAC 172.0.0.1
participant 2 200 PORT MAC 172.0.0.11
participant 3 300 PORT MAC 172.0.0.21 PORT MAC 172.0.0.22

announce 1 100.0.0.0/24:2 110.0.0.0/24
announce 2 140.0.0.0/24 150.0.0.0/24
announce 3 140.0.0.0/24 150.0.0.0/24

flow a1 80 >> b
flow a1 4321 >> c
flow a1 4322 >> c
flow c1 << 4321
flow c2 << 4322

node b1 i0 140.0.0.1 80 4321 4322 8888
node b1 i1 150.0.0.1 80 4321 4322 8888
node a1 i0 100.0.0.1 80 4321 4322 8888
node a1 i1 110.0.0.1 80 4321 4322 8888
node c1 i0 140.0.0.1 80 4321 4322 8888
node c1 i1 150.0.0.1 80 4321 4322 8888
node c2 i0 140.0.0.1 80 4321 4322 8888
node c2 i1 150.0.0.1 80 4321 4322 8888

test a1 i0 80 b1 i0 80
test a1 i0 4321 c1 i0 4321
test a1 i0 4322 c2 i0 4322
test a1 i0 8888 c1 i0 8888
```

## Test 1
This test is equivalent to test-ms and test-mt in the examples directory.
AS A directs its port 80 traffic to AS B, and its port 4321 and 4322 traffic to AS C.
AS C has inbound rules that further refine flows to routers C1 for port 4321 and C2 for port 4322.
```
flow a1 80 >> b
flow a1 4321 >> c
flow a1 4322 >> c
flow c1 << 4321
flow c2 << 4322
```
![Experimental Setup](https://docs.google.com/drawings/d/1mOw8i23mZYNSj1eH4wwXECLwx6SViR0NaI4bgnAnaHs/pub?w=960&h=720)

## Test 2 
This test is patterned on test 1, but adds 2 AS'es. It is intended to replicate a hardware test-bed configuration. A, C and D are patterned after A, B and C in test 1. An additional source, B, has its port 80 traffic sent to E. B also sends port 4321 and 4322 traffic to D.
```
flow a1 80 >> c
flow a1 4321 >> d
flow a1 4322 >> d
flow d1 << 4321
flow d2 << 4322
flow b1 80 >> e
flow b1 4321 >> e
flow b1 4322 >> e
```
![Experimental Setup](https://docs.google.com/drawings/d/1H8d_kWxee9txHfZx2k479A8NXjQHuHR3qnuTrcf3sBc/pub?w=960&h=720)

## Test 3 
This test replicates test 1 four times, with each set of 3 AS'es restricted to its own peering group.
```
flow a1 80 >> b
flow a1 4321 >> c
flow a1 4322 >> c
flow c1 << 4321
flow c2 << 4322

flow d1 80 >> e
flow d1 4321 >> f
flow d1 4322 >> f
flow f1 << 4321
flow f2 << 4322

flow g1 80 >> h
flow g1 4321 >> i
flow g1 4322 >> i
flow i1 << 4321
flow i2 << 4322

flow j1 80 >> k
flow j1 4321 >> l
flow j1 4322 >> l
flow l1 << 4321
flow l2 << 4322
```
![Experimental Setup](https://docs.google.com/drawings/d/1LHTyuZR8qbzq7wp1HgpiprpMGeQ2XY2sUvlu6XwgcNM/pub?w=960&h=720)

## Test 4
This test includes only outbound flow rules. AS A sends traffic to 8 other AS'es based on port number.
```
flow a1 80 >> b
flow a1 81 >> c
flow a1 82 >> d
flow a1 83 >> e
flow a1 84 >> f
flow a1 85 >> g
flow a1 86 >> h
flow a1 87 >> i
```
![Experimental Setup](https://docs.google.com/drawings/d/17XaTGOoCNJ8LDa5q_1Gh1-fpz64S7uRoY_m74mWXpRE/pub?w=960&h=720)

## Test 5
This test includes only inbound flow rules. Inbound traffic is routed to 1 of 8 edge routers based on port number.
```
flow b1 << 80
flow b2 << 81
flow b3 << 82
flow b4 << 83
flow b5 << 84
flow b6 << 85
flow b7 << 86
flow b8 << 87
flow b9 << 88
```
![Experimental Setup](https://docs.google.com/drawings/d/1VTqNpCAfSlrvFzB8uM2bflbTBSGsMwV1AnWoc2IBwsc/pub?w=960&h=720)

## test 6
This test performs outbound flows across all AS'es. Each AS sources traffic to its 2 neighbors. Port 80 traffic moves clockwise.  Port 81 traffic moves counter clockwise.
```
flow a1 80 >> b
flow b1 80 >> c
flow c1 80 >> a
flow a1 81 >> c
flow b1 81 >> a
flow c1 81 >> b
```

![Experimental Setup](https://docs.google.com/drawings/d/1BjwMis_0_1QpmcmBonSbojuwbHC64L6YdB61zrJUl64/pub?w=960&h=720)
